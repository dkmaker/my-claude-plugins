# my-plugin-dev Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Create a dedicated plugin that provides a development toolkit for maintaining, developing, troubleshooting, and scaffolding plugins in the my-claude-plugins marketplace repository.

**Architecture:** Single skill (`dev`) with supporting workflow and reference files. The skill auto-detects context (repo location, dev vs production mode, target plugin) and routes to the appropriate workflow document. Documentation is sourced from `claude-docs` CLI with a fallback chain.

**Tech Stack:** Markdown (SKILL.md + supporting files), YAML frontmatter, JSON (plugin.json, marketplace.json)

---

### Task 1: Create Plugin Scaffold

**Files:**
- Create: `my-plugin-dev/.claude-plugin/plugin.json`

**Step 1: Create directory structure**

```bash
mkdir -p my-plugin-dev/.claude-plugin
mkdir -p my-plugin-dev/skills/dev/workflows
mkdir -p my-plugin-dev/skills/dev/reference
```

**Step 2: Create plugin.json**

Create `my-plugin-dev/.claude-plugin/plugin.json`:

```json
{
  "name": "my-plugin-dev",
  "description": "Development toolkit for the my-claude-plugins marketplace repository",
  "version": "1.0.0",
  "author": {
    "name": "Christian Pedersen",
    "email": "christian@dkmaker.xyz"
  },
  "keywords": ["development", "plugin-dev", "toolkit", "maintenance"]
}
```

**Step 3: Verify structure**

Run: `find my-plugin-dev -type f -o -type d | sort`

Expected:
```
my-plugin-dev
my-plugin-dev/.claude-plugin
my-plugin-dev/.claude-plugin/plugin.json
my-plugin-dev/skills
my-plugin-dev/skills/dev
my-plugin-dev/skills/dev/reference
my-plugin-dev/skills/dev/workflows
```

**Step 4: Commit**

```bash
git add my-plugin-dev/.claude-plugin/plugin.json
git commit -m "feat(my-plugin-dev): add plugin scaffold with manifest"
```

---

### Task 2: Register in Marketplace

**Files:**
- Modify: `.claude-plugin/marketplace.json` — add entry at end of plugins array

**Step 1: Add marketplace entry**

Add to the `plugins` array in `.claude-plugin/marketplace.json`, after the `generate-image` entry:

```json
{
  "name": "my-plugin-dev",
  "source": "./my-plugin-dev",
  "description": "Development toolkit for maintaining and developing the my-claude-plugins marketplace",
  "version": "1.0.0",
  "keywords": ["development", "plugin-dev", "toolkit", "maintenance"],
  "category": "development"
}
```

**Step 2: Validate JSON syntax**

Run: `jq . .claude-plugin/marketplace.json > /dev/null && echo "Valid JSON"`

Expected: `Valid JSON`

**Step 3: Verify entry count**

Run: `jq '.plugins | length' .claude-plugin/marketplace.json`

Expected: `9` (was 8, now 9 with my-plugin-dev)

**Step 4: Commit**

```bash
git add .claude-plugin/marketplace.json
git commit -m "feat(my-plugin-dev): register plugin in marketplace"
```

---

### Task 3: Create reference/repo-map.md

This is the living inventory of the entire repository. Must be generated by scanning the actual filesystem.

**Files:**
- Create: `my-plugin-dev/skills/dev/reference/repo-map.md`

**Step 1: Scan all plugins and build the repo map**

Create `my-plugin-dev/skills/dev/reference/repo-map.md` with the following content. This must be built by reading all plugin.json files, hooks.json files, skills directories, and MCP configs across the repo:

```markdown
# my-claude-plugins Repository Map

> This file is auto-regenerated. Do not edit manually — it gets rebuilt when structural changes are made via the dev skill.

## Repository

- **Location**: /home/cp/code/dkmaker/my-claude-plugins
- **GitHub**: dkmaker/my-claude-plugins
- **Branch convention**: `feat/<plugin-name>-<description>`
- **Commit convention**: `feat(<plugin>):` / `fix(<plugin>):` / `docs(<plugin>):`

## Plugins Overview

| Plugin | Version | Type | Category | Components |
|--------|---------|------|----------|------------|
| baseline | 2.1.0 | Feature | productivity | hooks, statusline |
| claude-expert | 2.0.0 | Feature | knowledge | hooks, skills |
| generate-image | 1.1.0 | Feature | creative | skills |
| mcp-rest-api | — | External (GitHub) | productivity | mcpServers |
| my-plugin-dev | 1.0.0 | Feature | development | skills |
| perplexity | 0.5.0 | MCP wrapper | productivity | mcpServers |
| playwright | 1.0.0 | MCP wrapper | testing | mcpServers |
| transcript | 1.0.0 | Feature | productivity | hooks, commands, scripts |
| wsl-ssh-agent | 1.0.1 | Feature | productivity | hooks, scripts |

## Per-Plugin Detail

### baseline (v2.1.0) — Feature plugin
- **Manifest**: `baseline/.claude-plugin/plugin.json`
- **Hooks**: `baseline/hooks/hooks.json`
  - SessionStart → `baseline/hooks/scripts/baseline-check.sh` (10s timeout)
- **Statusline**: `baseline/statusline/statusline.sh`
- **Dependencies**: jq (critical), git (critical), ripgrep (optional)
- **Behavior**: Validates tools, applies recommended settings with 2-hour throttling, creates settings backups

### claude-expert (v2.0.0) — Feature plugin
- **Manifest**: `claude-expert/.claude-plugin/plugin.json`
- **Hooks**: `claude-expert/hooks/hooks.json`
  - SessionStart → `claude-expert/hooks/scripts/sessionstart.sh` (5s timeout)
- **Skills**: `claude-expert/skills/docs/SKILL.md`
  - `/my-claude-plugins:claude-expert:docs` — loads Claude Code documentation via `claude-docs` CLI
  - allowed-tools: `Bash(claude-docs:*)`
- **External CLI**: `claude-docs` (installed globally by the SessionStart hook from GitHub releases)
- **Behavior**: Installs/updates claude-docs CLI, injects system prompt to use docs skill

### generate-image (v1.1.0) — Feature plugin
- **Manifest**: `generate-image/.claude-plugin/plugin.json`
- **Skills**: `generate-image/skills/gemini/SKILL.md`
  - `/my-claude-plugins:generate-image:gemini` — AI image generation via Google Gemini
  - allowed-tools: `Bash, Write, Read, Glob, AskUserQuestion`
  - argument-hint: `[prompt description or 'interactive' for guided mode]`
- **Scripts**: `generate-image/skills/gemini/scripts/` (check-setup.sh, generate.sh)
- **Dependencies**: Python 3.x, venv, GEMINI_API_KEY

### mcp-rest-api — External plugin (GitHub)
- **Source**: `dkmaker/mcp-rest-api` (GitHub repo, not local)
- **Type**: MCP server for REST API testing

### my-plugin-dev (v1.0.0) — Feature plugin
- **Manifest**: `my-plugin-dev/.claude-plugin/plugin.json`
- **Skills**: `my-plugin-dev/skills/dev/SKILL.md`
  - `/my-claude-plugins:my-plugin-dev:dev` — development toolkit
  - Workflows: develop, troubleshoot, scaffold
  - Supporting files in `workflows/` and `reference/`

### perplexity (v0.5.0) — MCP wrapper
- **Manifest**: `perplexity/.claude-plugin/plugin.json`
- **MCP Server**: `npx -y @perplexity-ai/mcp-server`
  - Env: `PERPLEXITY_API_KEY` (required), `PERPLEXITY_TIMEOUT_MS` (optional)
- **Tools provided**: perplexity_ask, perplexity_search, perplexity_reason, perplexity_research

### playwright (v1.0.0) — MCP wrapper
- **Manifest**: `playwright/.claude-plugin/plugin.json`
- **MCP Server**: `npx -y @playwright/mcp@latest`
- **Tools provided**: Browser automation (navigate, click, screenshot, etc.)

### transcript (v1.0.0) — Feature plugin
- **Manifest**: `transcript/.claude-plugin/plugin.json`
- **Hooks**: `transcript/hooks/hooks.json`
  - SessionStart → `transcript/hooks/scripts/sessionstart.sh`
- **Commands**:
  - `transcript/commands/create.md` — `/transcript:create` generates HTML report
  - `transcript/commands/help.md` — `/transcript:help` shows usage guide
- **Scripts**: `transcript/scripts/` (transcript-helper.sh, normalize-transcript.sh, render-html-js.sh, create-transcript.sh)
- **Behavior**: Sets CLAUDE_ACTIVE_TRANSCRIPT, CLAUDE_SESSION_ID env vars

### wsl-ssh-agent (v1.0.1) — Feature plugin
- **Manifest**: `wsl-ssh-agent/.claude-plugin/plugin.json`
- **Hooks**: `wsl-ssh-agent/hooks/hooks.json`
  - SessionStart → `wsl-ssh-agent/hooks/scripts/ssh-agent-bridge.sh` (15s timeout)
- **Dependencies**: WSL2, socat, Windows SSH agent (1Password or native)
- **Behavior**: Bridges Windows SSH agent to WSL via npiperelay.exe + socat + Unix socket

## File Conventions

- **Hook JSON output format**: `{ "hookSpecificOutput": { "hookEventName": "SessionStart", "additionalContext": "..." }, "systemMessage": "..." }`
- **Plugin components**: Always at plugin root level, NEVER inside `.claude-plugin/`
- **MCP env vars**: Use `${ENV_VAR}` syntax for interpolation at runtime
- **Scripts**: Must be executable (`chmod +x`)
- **Plugin cache**: `~/.claude/plugins/cache/my-claude-plugins/<plugin-name>/`
- **Local dev**: Use `claude --plugin-dir /home/cp/code/dkmaker/my-claude-plugins/<plugin-name>`
```

**Step 2: Verify file renders correctly**

Run: `head -5 my-plugin-dev/skills/dev/reference/repo-map.md`

Expected: First 5 lines of the file with the header and note.

**Step 3: Commit**

```bash
git add my-plugin-dev/skills/dev/reference/repo-map.md
git commit -m "feat(my-plugin-dev): add repository map reference"
```

---

### Task 4: Create reference/plugin-templates.md

**Files:**
- Create: `my-plugin-dev/skills/dev/reference/plugin-templates.md`

**Step 1: Create templates file**

Create `my-plugin-dev/skills/dev/reference/plugin-templates.md` with boilerplate templates derived from existing plugins in the repo. Each template has inline comments explaining what to customize:

```markdown
# Plugin Templates

> Templates for creating new plugins in the my-claude-plugins marketplace.
> Each template is derived from existing plugins in the repo.
> Before using these templates, verify current conventions via `claude-docs`.

## Feature Plugin — plugin.json

Based on: `baseline/.claude-plugin/plugin.json`

```json
{
  "name": "PLUGIN_NAME",
  "version": "1.0.0",
  "description": "BRIEF_DESCRIPTION",
  "author": {
    "name": "Christian Pedersen",
    "email": "christian@dkmaker.xyz"
  },
  "keywords": ["KEYWORD1", "KEYWORD2"]
}
```

## MCP Wrapper — plugin.json

Based on: `perplexity/.claude-plugin/plugin.json`

```json
{
  "name": "PLUGIN_NAME",
  "version": "1.0.0",
  "description": "BRIEF_DESCRIPTION",
  "author": {
    "name": "Christian Pedersen",
    "email": "christian@dkmaker.xyz"
  },
  "keywords": ["mcp", "KEYWORD1"],
  "mcpServers": {
    "SERVER_NAME": {
      "type": "stdio",
      "command": "npx",
      "args": ["-y", "NPM_PACKAGE_NAME"],
      "env": {
        "API_KEY": "${ENV_VAR_NAME}"
      }
    }
  }
}
```

## hooks.json — SessionStart

Based on: `baseline/hooks/hooks.json`

```json
{
  "description": "WHAT_THIS_HOOK_DOES",
  "hooks": {
    "SessionStart": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "${CLAUDE_PLUGIN_ROOT}/hooks/scripts/SCRIPT_NAME.sh",
            "timeout": 10
          }
        ]
      }
    ]
  }
}
```

## Hook Script Skeleton

Based on: `baseline/hooks/scripts/baseline-check.sh`

```bash
#!/usr/bin/env bash
# PLUGIN_NAME SessionStart hook
# PURPOSE_DESCRIPTION

set -euo pipefail

# ── Output valid hook JSON ──────────────────────────────────────
# Claude Code expects this exact format from hook scripts

additional_context="Instructions or context injected into Claude's prompt"
system_message="Message shown to user in the session start output"

cat <<EOF
{
  "hookSpecificOutput": {
    "hookEventName": "SessionStart",
    "additionalContext": "${additional_context}"
  },
  "systemMessage": "${system_message}"
}
EOF
```

## SKILL.md — Standard (auto + user invocable)

Based on: `claude-expert/skills/docs/SKILL.md`

```yaml
---
name: SKILL_NAME
description: WHAT_THIS_SKILL_DOES. Use when TRIGGER_CONDITIONS.
allowed-tools: TOOL1, TOOL2
---

# Skill Title

Instructions for Claude when this skill is invoked.

## When to Use

- Condition 1
- Condition 2

## How to Use

Step-by-step instructions.
```

## SKILL.md — User-Only (disable-model-invocation)

```yaml
---
name: SKILL_NAME
description: WHAT_THIS_SKILL_DOES
disable-model-invocation: true
argument-hint: "[ARG_DESCRIPTION]"
allowed-tools: TOOL1, TOOL2
---

# Skill Title

Instructions for Claude when user invokes /SKILL_NAME $ARGUMENTS.
```

## Marketplace Entry

Based on: `.claude-plugin/marketplace.json` entries

```json
{
  "name": "PLUGIN_NAME",
  "source": "./PLUGIN_NAME",
  "description": "BRIEF_DESCRIPTION",
  "version": "1.0.0",
  "keywords": ["KEYWORD1", "KEYWORD2"],
  "category": "CATEGORY"
}
```

Valid categories in this repo: `knowledge`, `productivity`, `testing`, `creative`, `development`

## Directory Structures

### Feature Plugin (hooks + skills)

```
PLUGIN_NAME/
├── .claude-plugin/
│   └── plugin.json
├── hooks/
│   ├── hooks.json
│   └── scripts/
│       └── hook-script.sh    (chmod +x)
├── skills/
│   └── skill-name/
│       └── SKILL.md
└── README.md
```

### Feature Plugin (skills only)

```
PLUGIN_NAME/
├── .claude-plugin/
│   └── plugin.json
├── skills/
│   └── skill-name/
│       ├── SKILL.md
│       └── scripts/          (optional)
└── README.md
```

### MCP Wrapper

```
PLUGIN_NAME/
├── .claude-plugin/
│   └── plugin.json           (includes mcpServers)
└── README.md
```

### Feature Plugin (hooks + commands)

```
PLUGIN_NAME/
├── .claude-plugin/
│   └── plugin.json
├── hooks/
│   ├── hooks.json
│   └── scripts/
│       └── hook-script.sh    (chmod +x)
├── commands/
│   └── command-name.md
├── scripts/                  (optional, for command helpers)
└── README.md
```
```

**Step 2: Commit**

```bash
git add my-plugin-dev/skills/dev/reference/plugin-templates.md
git commit -m "feat(my-plugin-dev): add plugin boilerplate templates"
```

---

### Task 5: Create SKILL.md — Main Entry Point

This is the core of the plugin. It auto-detects context and routes to workflows.

**Files:**
- Create: `my-plugin-dev/skills/dev/SKILL.md`

**Step 1: Create the main skill file**

Create `my-plugin-dev/skills/dev/SKILL.md`:

````markdown
---
name: dev
description: Development toolkit for the my-claude-plugins marketplace. Use when working on plugin development, troubleshooting plugin issues, creating new plugins, or maintaining the my-claude-plugins repository.
argument-hint: "[develop|troubleshoot|scaffold] [plugin-name]"
allowed-tools: Bash, Read, Write, Edit, Glob, Grep, Bash(git:*), Bash(claude:*)
---

# my-plugin-dev: Development Toolkit

Development toolkit for the **my-claude-plugins** marketplace repository (`dkmaker/my-claude-plugins`).

## Step 1: Auto-Detect Context

Before doing anything, gather context:

### Detect Repository

Check if we're inside the my-claude-plugins repo:

```bash
# Check for marketplace.json with our known plugins
if [ -f ".claude-plugin/marketplace.json" ]; then
  jq -r '.name' .claude-plugin/marketplace.json
fi
```

If not in the repo, check common locations:
- `/home/cp/code/dkmaker/my-claude-plugins`

If repo not found, ask the user for the path.

### Detect Dev vs Production Mode

Check how plugins are loaded:
- **Dev mode**: Plugins loaded via `--plugin-dir` pointing to the repo source
- **Production mode**: Plugins loaded from cache at `~/.claude/plugins/cache/my-claude-plugins/`

If production mode is detected, warn:
> **You're running with cached plugins.** Changes to source files won't take effect.
> To develop locally, restart Claude Code with:
> ```
> claude --plugin-dir /home/cp/code/dkmaker/my-claude-plugins/<plugin-name>
> ```

### Gather Status

```bash
# Current branch and dirty state
git status --short --branch
# Which plugins have changes
git diff --name-only | grep -oP '^[^/]+' | sort -u
```

Present a context summary to the user before proceeding.

## Step 2: Documentation Source

This skill depends on `claude-docs` CLI as the source of truth for Claude Code conventions.

**Priority chain:**

1. **Check for claude-docs**: Run `command -v claude-docs`
   - If available, use `claude-docs get <slug>` before generating any plugin component
   - Key slugs: `plugins`, `plugins-reference`, `skills`, `hooks-guide`, `hooks`, `mcp`, `plugin-marketplaces`
   - Run `claude-docs list` to discover all available topics

2. **If claude-docs not found**: Ask the user to enable the claude-expert plugin:
   > The `claude-expert` plugin provides the `claude-docs` CLI which is the source of truth for Claude Code documentation.
   > Enable it with: `/plugin install claude-expert@my-claude-plugins`

3. **Last resort fallback**: If user declines claude-expert, fetch documentation directly:
   - Documentation index: `https://code.claude.com/docs/llms.txt`
   - Use WebFetch to pull the index, then fetch specific page URLs from it
   - Warn: "Using remote docs — install claude-expert for faster, cached access"

**IMPORTANT**: Before generating any plugin component (hooks, skills, MCP config, plugin.json), ALWAYS verify the current format via this documentation chain. Never rely on training data for Claude Code specifics.

## Step 3: Route to Workflow

Based on `$ARGUMENTS`:

| First argument | Action |
|----------------|--------|
| `develop` | Load [workflows/develop.md](workflows/develop.md) — full dev lifecycle |
| `troubleshoot` | Load [workflows/troubleshoot.md](workflows/troubleshoot.md) — diagnostics & debugging |
| `scaffold` | Load [workflows/scaffold.md](workflows/scaffold.md) — create a new plugin |
| *(none)* | Show the three options below and ask which workflow |

If no argument provided, present:

1. **develop** — Make changes to an existing plugin (branch, edit, test, validate, PR)
2. **troubleshoot** — Debug why a plugin/hook/skill/MCP isn't working
3. **scaffold** — Create a brand new plugin from scratch

Also show:
- Current branch and dirty files
- Whether in dev or production mode
- Which plugins have uncommitted changes
- The `claude` command line for local dev testing

## Reference Files

- [reference/repo-map.md](reference/repo-map.md) — Complete inventory of all plugins, their components, and file paths
- [reference/plugin-templates.md](reference/plugin-templates.md) — Boilerplate templates for every plugin type

Load `repo-map.md` when you need to understand the current state of any plugin.
Load `plugin-templates.md` when creating or modifying plugin components.
````

**Step 2: Verify frontmatter parses**

Run: `head -6 my-plugin-dev/skills/dev/SKILL.md`

Expected: The YAML frontmatter block with name, description, argument-hint, allowed-tools.

**Step 3: Commit**

```bash
git add my-plugin-dev/skills/dev/SKILL.md
git commit -m "feat(my-plugin-dev): add main SKILL.md entry point with auto-detection"
```

---

### Task 6: Create workflows/develop.md

**Files:**
- Create: `my-plugin-dev/skills/dev/workflows/develop.md`

**Step 1: Create the develop workflow**

Create `my-plugin-dev/skills/dev/workflows/develop.md`:

````markdown
# Workflow: Develop

Full development lifecycle for making changes to an existing plugin.

## 1. Sync & Branch

```bash
# Fetch latest from origin
git fetch origin

# Check current branch
git branch --show-current
```

- **If on `main`**: Create a feature branch:
  ```bash
  git checkout -b feat/<plugin-name>-<brief-description>
  ```
- **If on a feature branch**: Verify it's up to date:
  ```bash
  git log --oneline origin/main..HEAD
  ```

## 2. Identify Target Plugin

Determine which plugin to work on:

1. From `$ARGUMENTS[1]` if the user provided a plugin name
2. From CWD if currently inside a plugin directory
3. Ask the user — show the plugin list from [repo-map.md](../reference/repo-map.md)

Once identified, load the plugin's detail section from repo-map.md to understand its current structure.

## 3. Make Changes

- Show the user the plugin's current file tree
- Reference [repo-map.md](../reference/repo-map.md) for full component inventory
- Before creating or modifying any component, consult `claude-docs` for the current format:
  - Hooks: `claude-docs get hooks-guide` and `claude-docs get hooks`
  - Skills: `claude-docs get skills`
  - Plugin manifest: `claude-docs get plugins-reference`
  - MCP config: `claude-docs get mcp`
- Reference [plugin-templates.md](../reference/plugin-templates.md) for boilerplate
- Follow existing repo patterns for consistency

## 4. Local Testing

Generate the exact command for the user to test their changes:

**Single plugin under development:**
```
claude --plugin-dir /home/cp/code/dkmaker/my-claude-plugins/<plugin-name>
```

**Multiple plugins (e.g., plugin + its dependency):**
```
claude --plugin-dir /home/cp/code/dkmaker/my-claude-plugins/<plugin-a> --plugin-dir /home/cp/code/dkmaker/my-claude-plugins/<plugin-b>
```

**What to test based on what changed:**

| Changed component | How to test |
|-------------------|-------------|
| SessionStart hook | Restart Claude Code, check startup output |
| Hook script | Run manually: `bash <script> \| jq .` |
| Skill (SKILL.md) | Invoke: `/my-plugin-dev:<skill-name>` or ask Claude a matching question |
| MCP server config | Check `/mcp` for server status and available tools |
| Command (.md) | Invoke: `/<command-name>` |
| plugin.json | Check `/plugin` list, verify metadata |

**IMPORTANT**: Remind the user they must restart Claude Code to pick up changes when using `--plugin-dir`.

## 5. Validate

Run these checks before committing:

```bash
# JSON syntax validation
jq . <plugin>/hooks/hooks.json 2>&1 || echo "FAIL: hooks.json"
jq . <plugin>/.claude-plugin/plugin.json 2>&1 || echo "FAIL: plugin.json"
jq . .claude-plugin/marketplace.json 2>&1 || echo "FAIL: marketplace.json"

# Check scripts are executable
find <plugin> -name "*.sh" ! -perm -111 -print

# Validate plugin structure
claude plugin validate /home/cp/code/dkmaker/my-claude-plugins/<plugin>
```

For SKILL.md files, verify the YAML frontmatter has:
- `name` field (or uses directory name)
- `description` field (required for auto-invocation)
- Valid `allowed-tools` if specified

If version was bumped in plugin.json, ensure marketplace.json matches.

## 6. Update Repo Map

If ANY structural changes were made, regenerate [repo-map.md](../reference/repo-map.md):

**Triggers for repo-map update:**
- New or removed plugin directories
- Added/removed/renamed skills or commands
- Changed hook configurations (new hooks, removed hooks, changed scripts)
- MCP server additions/removals
- Version bumps in plugin.json or marketplace.json
- New scripts or supporting files

**How to update**: Scan the filesystem and rebuild the entire repo-map.md. Do NOT patch it — regenerate to prevent drift. Include the repo-map changes in the same commit as the plugin changes.

## 7. Commit & PR

```bash
# Stage only the changed plugin's files (+ repo-map if updated)
git add <plugin>/
git add my-plugin-dev/skills/dev/reference/repo-map.md  # if updated

# Conventional commit
git commit -m "feat(<plugin>): <brief description of change>"
# or: fix(<plugin>):, docs(<plugin>):

# Push and create PR
git push -u origin <branch-name>
```

When creating the PR, include:
- Summary of what changed
- Which plugin was modified
- Testing instructions (the exact `claude --plugin-dir` command)
- What to verify (based on component type)
````

**Step 2: Commit**

```bash
git add my-plugin-dev/skills/dev/workflows/develop.md
git commit -m "feat(my-plugin-dev): add develop workflow"
```

---

### Task 7: Create workflows/troubleshoot.md

**Files:**
- Create: `my-plugin-dev/skills/dev/workflows/troubleshoot.md`

**Step 1: Create the troubleshoot workflow**

Create `my-plugin-dev/skills/dev/workflows/troubleshoot.md`:

````markdown
# Workflow: Troubleshoot

Diagnostic guide for when plugins, hooks, skills, or MCP servers aren't working.

## 1. Identify the Problem

From user input or ask:

- **Hook not running / wrong output**
- **Skill not appearing / not triggering**
- **MCP server not connecting**
- **Plugin not loading at all**
- **Cache out of sync with source**

## 2. Environment Check (always run first)

```bash
# Where are we?
pwd
git status --short --branch

# Claude Code version
claude --version

# Dev mode or production mode?
# Check if running with --plugin-dir (dev) or from cache (production)
ls ~/.claude/plugins/cache/my-claude-plugins/ 2>/dev/null
```

### Cache vs Source Comparison

Compare what's installed vs what's in the repo:

```bash
# For a specific plugin, compare directory contents
diff <(cd ~/.claude/plugins/cache/my-claude-plugins/<plugin> && find . -type f | sort) \
     <(cd /home/cp/code/dkmaker/my-claude-plugins/<plugin> && find . -type f | sort)
```

If there are differences, the cache is stale. Solutions:
1. **For development**: Restart with `claude --plugin-dir /home/cp/code/dkmaker/my-claude-plugins/<plugin>`
2. **For reinstall**: `/plugin uninstall <plugin>@my-claude-plugins` then `/plugin install <plugin>@my-claude-plugins`

## 3. Diagnostics by Component Type

### Hooks

```bash
# Is hooks.json valid JSON?
jq . <plugin>/hooks/hooks.json

# Are scripts executable?
ls -la <plugin>/hooks/scripts/

# Test script in isolation (should output valid hook JSON)
bash <plugin>/hooks/scripts/<script>.sh | jq .
```

**Expected hook output format:**
```json
{
  "hookSpecificOutput": {
    "hookEventName": "SessionStart",
    "additionalContext": "Text injected into Claude's context"
  },
  "systemMessage": "Text shown to user"
}
```

**Common hook failures:**
| Symptom | Cause | Fix |
|---------|-------|-----|
| Script not found | Wrong path in hooks.json | Use `${CLAUDE_PLUGIN_ROOT}/hooks/scripts/name.sh` |
| No output | Script not executable | `chmod +x hooks/scripts/name.sh` |
| Invalid JSON | Missing quotes, trailing comma | Validate with `jq .` |
| Timeout | Script takes too long | Increase `timeout` in hooks.json or optimize script |
| Silent failure | `set -e` exits on error | Run manually to see stderr |

For current hook format reference: `claude-docs get hooks-guide` and `claude-docs get hooks`

### Skills

```bash
# Check SKILL.md exists in correct location
ls <plugin>/skills/*/SKILL.md

# Verify YAML frontmatter (extract between --- markers)
sed -n '/^---$/,/^---$/p' <plugin>/skills/<name>/SKILL.md
```

**Common skill failures:**
| Symptom | Cause | Fix |
|---------|-------|-----|
| Not in /help menu | Missing or empty `description` | Add description to frontmatter |
| Claude doesn't use it | `disable-model-invocation: true` | Remove if you want auto-invocation |
| Not visible at all | Wrong directory structure | Must be `skills/<name>/SKILL.md`, not inside `.claude-plugin/` |
| Truncated | Too many skills, budget exceeded | Check `/context` for warnings |
| Can't find supporting files | Files not in skill directory | Reference with relative paths from SKILL.md |

For current skill format reference: `claude-docs get skills`

### MCP Servers

```bash
# Check MCP config in plugin.json
jq '.mcpServers' <plugin>/.claude-plugin/plugin.json

# Check if command exists
which npx && npx -y <package> --help 2>&1 | head -5

# Check required env vars
echo "API_KEY set: ${API_KEY:+yes}"
```

**Common MCP failures:**
| Symptom | Cause | Fix |
|---------|-------|-----|
| Server not starting | Command not found | Install Node.js / npx |
| Auth error | Missing API key | Set env var in `.claude/settings.local.json` or shell config |
| Tools not appearing | Server crash on start | Check `claude --debug` output |
| Timeout | Slow server startup | Check network, package download |

For current MCP format reference: `claude-docs get mcp`

### Plugin Not Loading

```bash
# Does plugin.json exist and parse?
jq . <plugin>/.claude-plugin/plugin.json

# Is it registered in marketplace?
jq '.plugins[] | select(.name == "<plugin>")' .claude-plugin/marketplace.json

# Is it enabled in user settings?
jq '.enabledPlugins' ~/.claude/settings.json 2>/dev/null

# Check with debug mode
claude --debug 2>&1 | head -50
```

**Common loading failures:**
| Symptom | Cause | Fix |
|---------|-------|-----|
| Not in plugin list | Not registered in marketplace.json | Add entry |
| Registered but not loading | Invalid plugin.json | Validate with `jq .` |
| Components missing | Files inside `.claude-plugin/` | Move to plugin root |
| Name conflict | Duplicate plugin name | Use unique kebab-case name |

For current plugin format reference: `claude-docs get plugins-reference`

## 4. Resolution

1. Apply the fix
2. If it was a cache issue, provide the command:
   - Dev mode: `claude --plugin-dir /home/cp/code/dkmaker/my-claude-plugins/<plugin>`
   - Reinstall: `/plugin uninstall <plugin>@my-claude-plugins && /plugin install <plugin>@my-claude-plugins`
3. Verify the fix works
4. If structural changes were made, update [repo-map.md](../reference/repo-map.md)
````

**Step 2: Commit**

```bash
git add my-plugin-dev/skills/dev/workflows/troubleshoot.md
git commit -m "feat(my-plugin-dev): add troubleshoot workflow"
```

---

### Task 8: Create workflows/scaffold.md

**Files:**
- Create: `my-plugin-dev/skills/dev/workflows/scaffold.md`

**Step 1: Create the scaffold workflow**

Create `my-plugin-dev/skills/dev/workflows/scaffold.md`:

````markdown
# Workflow: Scaffold

Create a brand new plugin from scratch with the correct structure, register it in the marketplace, and set up local testing.

## 1. Gather Requirements

Ask the user (one question at a time):

1. **Plugin name**: Must be kebab-case (lowercase, hyphens only). Will be used as:
   - Directory name
   - `name` field in plugin.json
   - Namespace prefix for skills: `/my-claude-plugins:<name>:<skill>`

2. **Plugin type**:
   - **Feature plugin** — hooks, skills, scripts, commands
   - **MCP server wrapper** — thin config wrapping an external MCP server
   - **Hybrid** — MCP server + custom skills/hooks

3. **Description**: Brief description for marketplace listing

4. **Category**: One of: `knowledge`, `productivity`, `testing`, `creative`, `development`

5. **Components needed** (for feature/hybrid plugins):
   - SessionStart hook? (Y/N)
   - Skills? (how many, names)
   - Commands? (how many, names)
   - MCP server config? (server name, npm package, env vars)
   - Scripts? (what they do)

## 2. Verify Current Conventions

Before generating anything, consult documentation for the latest formats:

```bash
# Check claude-docs is available
command -v claude-docs

# Load relevant docs
claude-docs get plugins-reference  # plugin.json schema
claude-docs get hooks-guide        # hooks.json format
claude-docs get skills             # SKILL.md frontmatter
claude-docs get plugin-marketplaces # marketplace entry format
```

If `claude-docs` is unavailable, follow the fallback chain from the main SKILL.md.

Also cross-reference with existing plugins in [repo-map.md](../reference/repo-map.md) to stay consistent with local patterns.

## 3. Generate Plugin Structure

Using templates from [plugin-templates.md](../reference/plugin-templates.md), create the plugin:

### For Feature Plugins:

```bash
# Create directory structure
mkdir -p <name>/.claude-plugin
mkdir -p <name>/hooks/scripts     # if hooks needed
mkdir -p <name>/skills/<skill>/   # for each skill
mkdir -p <name>/commands/         # if commands needed
mkdir -p <name>/scripts/          # if helper scripts needed
```

Generate files from templates, substituting:
- `PLUGIN_NAME` → the chosen name
- `BRIEF_DESCRIPTION` → the provided description
- `KEYWORD1`, `KEYWORD2` → relevant keywords
- Hook script content → based on plugin's purpose
- SKILL.md content → based on skill requirements

### For MCP Wrappers:

```bash
mkdir -p <name>/.claude-plugin
```

Generate `plugin.json` with `mcpServers` configuration.

### For All Plugins:

```bash
# Make all scripts executable
find <name> -name "*.sh" -exec chmod +x {} \;
```

## 4. Register in Marketplace

Add entry to `.claude-plugin/marketplace.json`:

```bash
# Show current entries for reference
jq '.plugins[].name' .claude-plugin/marketplace.json
```

Add the new entry to the `plugins` array. Use the marketplace entry template from plugin-templates.md.

Validate after adding:

```bash
jq . .claude-plugin/marketplace.json > /dev/null && echo "Valid JSON"
```

## 5. Local Test Setup

Provide the user with the exact command to test:

```
claude --plugin-dir /home/cp/code/dkmaker/my-claude-plugins/<name>
```

**Verification checklist based on components:**

| Component | Verify |
|-----------|--------|
| plugin.json | Plugin appears in `/plugin` list |
| SessionStart hook | Check startup output after restart |
| Hook script | Run: `bash <script> \| jq .` |
| Skill | Invoke: `/my-claude-plugins:<name>:<skill>` |
| Command | Invoke: `/my-claude-plugins:<name>:<command>` |
| MCP server | Check `/mcp` for server status |

Remind: **Scripts must be executable** and **Claude Code must be restarted** to pick up new plugins.

## 6. Update Repo Map

Regenerate [repo-map.md](../reference/repo-map.md) with the new plugin included. Scan the filesystem — don't patch.

## 7. Commit

```bash
git add <name>/
git add .claude-plugin/marketplace.json
git add my-plugin-dev/skills/dev/reference/repo-map.md

git commit -m "feat(<name>): add <name> plugin"
```

The plugin is now ready. If further development is needed, switch to the [develop workflow](develop.md).
````

**Step 2: Commit**

```bash
git add my-plugin-dev/skills/dev/workflows/scaffold.md
git commit -m "feat(my-plugin-dev): add scaffold workflow"
```

---

### Task 9: Validate Everything and Final Commit

**Files:**
- Verify all created files

**Step 1: Verify complete plugin structure**

Run: `find my-plugin-dev -type f | sort`

Expected:
```
my-plugin-dev/.claude-plugin/plugin.json
my-plugin-dev/skills/dev/SKILL.md
my-plugin-dev/skills/dev/reference/plugin-templates.md
my-plugin-dev/skills/dev/reference/repo-map.md
my-plugin-dev/skills/dev/workflows/develop.md
my-plugin-dev/skills/dev/workflows/scaffold.md
my-plugin-dev/skills/dev/workflows/troubleshoot.md
```

**Step 2: Validate JSON files**

```bash
jq . my-plugin-dev/.claude-plugin/plugin.json > /dev/null && echo "plugin.json: OK"
jq . .claude-plugin/marketplace.json > /dev/null && echo "marketplace.json: OK"
```

**Step 3: Verify SKILL.md frontmatter**

```bash
head -6 my-plugin-dev/skills/dev/SKILL.md
```

Expected: Valid YAML frontmatter with name, description, argument-hint, allowed-tools.

**Step 4: Test locally**

Run: `claude --plugin-dir /home/cp/code/dkmaker/my-claude-plugins/my-plugin-dev`

Verify:
- Plugin loads without errors
- `/my-plugin-dev:dev` appears in `/help`
- Invoking `/my-plugin-dev:dev` shows the context summary and workflow options

**Step 5: Validate plugin structure**

Run: `claude plugin validate /home/cp/code/dkmaker/my-claude-plugins/my-plugin-dev`

Expected: No errors.

---

## Task Summary

| Task | Description | Files |
|------|-------------|-------|
| 1 | Plugin scaffold + manifest | `my-plugin-dev/.claude-plugin/plugin.json` |
| 2 | Register in marketplace | `.claude-plugin/marketplace.json` |
| 3 | Repo map reference | `my-plugin-dev/skills/dev/reference/repo-map.md` |
| 4 | Plugin templates reference | `my-plugin-dev/skills/dev/reference/plugin-templates.md` |
| 5 | Main SKILL.md entry point | `my-plugin-dev/skills/dev/SKILL.md` |
| 6 | Develop workflow | `my-plugin-dev/skills/dev/workflows/develop.md` |
| 7 | Troubleshoot workflow | `my-plugin-dev/skills/dev/workflows/troubleshoot.md` |
| 8 | Scaffold workflow | `my-plugin-dev/skills/dev/workflows/scaffold.md` |
| 9 | Validate everything + test | All files |
