# Headless Session Runner — Design Document

## Problem

When Claude dispatches work after planning (via writing-plans), the two existing execution modes each have trade-offs:

1. **Subagent-driven** — stays in current session, but subagents share the same context window and can't persist across sessions
2. **Executing-plans (worktree)** — fresh context, but requires the user to manually open a new session

There's no way to launch a fully independent `claude -p` session from the current conversation, monitor it with minimal context cost, and get structured results back.

## Solution

A **3rd execution mode**: a Node.js wrapper script (`claude-runner.js`) that:

- Spawns `claude -p` with `--output-format stream-json --verbose`
- Filters the JSON event stream into compact one-liner progress output
- Tracks git state (commits, changed files, diff stats)
- Returns a structured JSON summary with session_id, tokens, cost, context usage %, and resume instructions
- Runs via Bash tool with `run_in_background` — the calling Claude gets notified on completion

## Architecture

```
Calling Claude (main session)

  Bash tool (run_in_background):
    node claude-runner.js --prompt "..." --cwd .

    claude-runner.js (Node.js)
      spawns: CLAUDECODE= claude -p "..."
        --output-format stream-json
        --verbose
        --dangerously-skip-permissions

      reads stdout line-by-line
      filters to one-liner progress on stdout
      tracks git state (start/end sha)

      on exit: prints JSON summary

  Claude gets notified when background task done
  Reads output: filtered progress + JSON summary
```

## Components

### 1. `superpowers/skills/headless-runner/claude-runner.js`

Node.js script (no external dependencies, uses only built-in modules).

#### CLI Interface

```
claude-runner.js [options]

Required (one of):
  --prompt <text>          Start new session with this prompt
  --resume <session-id>    Resume existing session with optional --prompt

Options:
  --cwd <path>             Working directory (default: current dir)
  --model <alias>          Model: sonnet, opus, haiku (default: sonnet)
  --max-turns <n>          Max agentic turns (default: 100)
  --max-budget <usd>       Max dollar spend (default: disabled)
  --system-prompt <text>   Appended to system prompt
  --allowed-tools <list>   Comma-separated tool list (default: all)
  --timeout <seconds>      Kill session after N seconds (default: disabled)
```

#### Startup Banner

All active settings shown at launch:

```
[12:45:01] Session started
           model: sonnet | context: 200k | max-turns: 100 | max-budget: disabled | timeout: disabled
```

Session ID is added to the banner once known (from first stream event).

#### Filtered Progress Output

One-liner per event, real-time to stdout:

```
[12:45:03] Read: src/db/schema.ts
[12:45:05] Edit: src/db/schema.ts
[12:45:07] Bash: npm run db:generate
[12:45:10] Write: src/routes/keywords.ts
[12:45:15] Bash: npm test -- --grep "keywords"
[12:45:18] Bash: git commit -m "feat: keyword routes"
[12:45:18] Commit: feat: keyword routes
[12:45:20] Text: Task 3 complete. All 8 tests passing.
```

Filtering rules:

| Stream event | Output |
|---|---|
| tool_use (Read) | `Read: <file_path>` |
| tool_use (Edit) | `Edit: <file_path>` |
| tool_use (Write) | `Write: <file_path>` |
| tool_use (Bash) | `Bash: <command truncated to 80 chars>` |
| tool_use (Grep/Glob) | `Search: <pattern>` |
| tool_use (Task) | `Subagent: <description>` |
| tool_result with git commit | `Commit: <message>` |
| assistant text (final) | `Text: <first 200 chars>` |
| result | Triggers JSON summary |
| Everything else | Dropped |

#### JSON Summary (on completion)

Delimited by `---CLAUDE-RUNNER-RESULT---` for easy parsing:

```json
{
  "session_id": "abc-123",
  "model": "claude-sonnet-4-5-20250929",
  "exit_code": 0,
  "duration_seconds": 120,
  "cost_usd": 0.45,
  "tokens": {
    "input": 45000,
    "output": 12000,
    "cache_read": 30000,
    "cache_creation": 15000,
    "context_window": 200000,
    "context_used_pct": 51
  },
  "tool_calls": 24,
  "git": {
    "start_sha": "a1b2c3d",
    "end_sha": "f4e5d6a",
    "commits": [
      "f4e5d6a feat: keyword routes",
      "b3c4d5e feat: category tree"
    ],
    "changed_files": 8,
    "insertions": 245,
    "deletions": 12,
    "uncommitted_changes": 0
  },
  "errors": [],
  "context_warning": false,
  "resume_command": "node claude-runner.js --resume abc-123 --prompt \"Continue from where you left off\""
}
```

#### JSON Summary — Built by the Wrapper

The JSON summary is constructed entirely by the Node.js wrapper from stream data — NOT generated by Claude. Sources:

- `session_id` — from `init` or `result` event
- `model` — from `assistant` message events
- Tool call counts — counted from `tool_use` events
- `modelUsage` — from the final `result` event (includes `contextWindow`, token counts, `costUSD`)
- `context_used_pct` — calculated: `(input + cacheRead + cacheCreation + output) / contextWindow * 100`
- Git stats — wrapper runs git commands at start and end to diff

#### Git Tracking

On start: record `git rev-parse HEAD` in the cwd.

On exit:
- Record new HEAD
- If HEAD changed: `git log --oneline <start>..<end>` for commits, `git diff --stat <start>..HEAD` for file changes
- If HEAD unchanged: check `git status --porcelain` for uncommitted changes

#### Error Handling

| Failure | Wrapper behavior |
|---|---|
| claude -p exits non-zero | Summary with exit_code: 1, stderr in errors |
| Stream ends without result event | Summary with partial data, incomplete: true |
| Process killed (timeout/signal) | Summary with exit_code: -1, killed: true |
| Spawn fails entirely | JSON summary with error, no session_id |

#### Context Warning

When `context_used_pct > 60`, the summary sets `context_warning: true`. The calling Claude should start a fresh session (new `--prompt`) instead of `--resume` for the next batch. The wrapper never kills the session — it only reports context health.

### 2. `superpowers/skills/headless-runner/SKILL.md`

Skill definition that teaches Claude:
- When to use headless runner vs subagent-driven vs executing-plans
- How to construct the claude-runner.js command
- How to interpret the JSON summary
- How to handle context_warning (new session vs resume)
- How to provide resume instructions in the prompt

## Integration Points

### writing-plans handoff (modified)

Current state offers 2 options. New state offers 3:

```
Plan complete and saved. Three execution options:

1. Subagent-Driven (this session)
   - Fresh subagent per task, review between tasks
   - Fast iteration, stays in current context

2. Parallel Session (separate worktree)
   - Open new session with executing-plans
   - Batch execution with human checkpoints

3. Headless Runner (background)
   - Launches claude -p in background via Bash tool
   - Minimal context cost — filtered one-liner progress
   - Auto-detects context exhaustion, suggests new session
   - You stay in control, get notified when done

Which approach?
```

When option 3 is chosen: REQUIRED SUB-SKILL: superpowers:headless-runner

### Calling pattern from skill

```bash
# Bash tool, run_in_background=true
node /path/to/superpowers/skills/headless-runner/claude-runner.js \
  --prompt "You are implementing a plan. Here is your task:

Task 3: Admin keyword routes
[full task description from plan]

Work in the current directory. Follow TDD. Commit after each task.
When done, summarize what you implemented and any issues." \
  --cwd /path/to/worktree \
  --model sonnet
```

### Context-aware batching

```
Batch 1: dispatch Task 1-3 via claude-runner.js
  Result: context_warning: false -> resume for next batch

Batch 2: dispatch Task 4-6 via claude-runner.js --resume <session-id>
  Result: context_warning: true -> start fresh for next batch

Batch 3: dispatch Task 7-9 via claude-runner.js --prompt "..." (new session)
  Result: context_warning: false -> resume if needed
```

## Design Decisions

1. **Node.js over Bash** — native JSON parsing, more robust, Node.js always available
2. **Script in plugin, not heredoc** — testable, versionable, follows existing patterns
3. **Wrapper builds JSON, not Claude** — zero risk of malformed output
4. **Context warning, not auto-kill** — wrapper reports health, calling Claude decides
5. **Git tracking via wrapper** — records start/end sha, diff stats regardless of stream content
6. **`---CLAUDE-RUNNER-RESULT---` delimiter** — easy for calling Claude to find JSON in output
7. **Default max-turns=100** — high enough for multi-task batches (single task is ~15-20 tool calls)
8. **All settings in startup banner** — calling Claude and user can verify configuration
